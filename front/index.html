<html>
    <head>
        <title>
            Pathfinding agents comparison
        </title>
        <style>
            /* Un peu de CSS pour centrer et voir le canvas */
            body { font-family: sans-serif; text-align: center; }
            #grid { border: 1px solid #333; margin-top: 10px; cursor: pointer; }
            button { padding: 10px 15px; font-size: 16px; cursor: pointer; }
        </style>
    </head>
    <body>
        <div id="toolbar">
            <button onclick="findPathGlobal('dijkstra')">Dijkstra</button>
            <button onclick="findPathGlobal('astar')">A*</button>
            <button onclick="resetGrid()">Reset</button>
            <button onclick="nextStep()">Next Step</button>
        </div>

        <canvas id="grid" width="600" height="600"></canvas>
        
        <script src="pathfinding.js"></script>
        <script>
            var pathfinder = null;
            var canvas = document.getElementById('grid');
            var ctx = canvas.getContext('2d');
            var cellSize = 30;

            // Cpp module loading
            Module.onRuntimeInitialized = function() {
                pathfinder = new Module.PathFinding(20, 20);
                drawGrid();
                console.log("Pathfinder initialized");
            };

            function drawGrid() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                ctx.strokeStyle = "#CCCCCC";
                ctx.lineWidth = 1;

                for (var x = 0; x <= canvas.width; x += cellSize) {
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                }

                for (var y = 0; y <= canvas.height; y += cellSize) {
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                }
                ctx.stroke();
            }

            canvas.addEventListener('click', function(event) {
                if(!pathfinder) return;
                var rect = canvas.getBoundingClientRect();
                var x = Math.floor((event.clientX - rect.left) / cellSize);
                var y = Math.floor((event.clientY - rect.top) / cellSize);
                if (x >= 20 || y >= 20) return;

                pathfinder.addObstacle(x, y);
                ctx.fillStyle = "black";
                ctx.fillRect(x * cellSize + 1, y * cellSize + 1, cellSize - 2, cellSize - 2);
            });

            function findPathGlobal(algo) {
                if(!pathfinder) return;
                var path = pathfinder.findPath(algo);
                console.log(path)
                
                ctx.fillStyle = "blue";
                for(var i = 0; i < path.size(); i++) {
                    var point = path.get(i);
                    // Dessin du chemin
                    ctx.fillRect(point.x * cellSize + 1, point.y * cellSize + 1, cellSize - 2, cellSize - 2);
                    console.log("PATH SIZE : " + path.size())
                }
                path.delete(); 
            }

            function resetGrid() {
                if(pathfinder) {
                    pathfinder.clearObstacles(20, 20);
                }
                drawGrid();
            }

            function nextStep(){
                //TODO
            }

        </script>
    </body>
</html>